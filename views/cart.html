<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compra - Paracordial</title>
    <link rel="stylesheet" href="../scss/cart.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chivo:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-container">
                <div class="logo">
                    <img src="../assets/img/logo.png" alt="Paracordial">
                </div>
                <button class="menu-toggle" id="menuToggle" aria-label="Abrir menú">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <ul class="nav-menu" id="navMenu">
                    <li><a href="../index.html">Inicio</a></li>
                    <li><a href="#">Productos</a></li>
                    <li><a href="#">Acerca de</a></li>
                    <li><a href="#">Contacto</a></li>
                </ul>
                <div class="nav-icons">
                    <a href="#" class="icon-link" aria-label="Buscar">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </a>
                    <a href="#" class="icon-link" aria-label="Usuario">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </a>
                    <a href="#" class="icon-link cart active" aria-label="Carrito">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                        </svg>
                        <span class="cart-count" id="cart-count">0</span>
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <main class="container">
        <h1 class="page-title">Carrito de Compra</h1>

        <div class="cart-layout">
            <section class="cart-items" id="cart-items">
                <p style="text-align: center; padding: 48px 16px;">Cargando carrito...</p>
            </section>

            <aside class="cart-summary">
                <h2 class="summary-title">Resumen del pedido</h2>
                
                <div class="summary-line">
                    <span>Subtotal</span>
                    <span id="summary-subtotal">0,00 €</span>
                </div>
                
                <div class="summary-line">
                    <span>Envío</span>
                    <span id="summary-shipping">3,99 €</span>
                </div>
                
                <div class="summary-divider"></div>
                
                <div class="summary-line summary-total">
                    <span>Total</span>
                    <span id="summary-total">0,00 €</span>
                </div>

                <button class="btn btn-primary btn-block" disabled>Proceder al pago</button>
                
                <a href="../index.html" class="continue-shopping">Continuar comprando</a>
            </aside>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>Paracordial</h4>
                    <p>Tu tienda de confianza para productos de Paracord artesanales y de alta calidad.</p>
                </div>
                <div class="footer-section">
                    <h4>Navegación</h4>
                </div>
                <div class="footer-section">
                    <h4>Información</h4>
                </div>
                <div class="footer-section">
                    <h4>Contacto</h4>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Paracordial. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <script>
        // Menú móvil toggle
        const menuToggle = document.getElementById('menuToggle');
        const navMenu = document.getElementById('navMenu');

        menuToggle.addEventListener('click', () => {
            navMenu.classList.toggle('active');
            menuToggle.classList.toggle('active');
        });

        // Cerrar menú al hacer clic en un enlace
        const navLinks = document.querySelectorAll('.nav-menu a');
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                navMenu.classList.remove('active');
                menuToggle.classList.remove('active');
            });
        });

        let cartData = null;

        // Cargar carrito
        async function loadCart() {
            try {
                const response = await fetch('/student008/shop/endpoints/get_cart.php');
                const data = await response.json();

                if (!data.success) {
                    if (data.redirect) {
                        alert('Debes iniciar sesión para ver tu carrito');
                        window.location.href = data.redirect;
                        return;
                    }
                    throw new Error(data.error);
                }

                cartData = data;
                renderCart();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('cart-items').innerHTML = `
                    <p style="text-align: center; padding: 48px 16px; color: #c62828;">
                        Error al cargar el carrito. Por favor, recarga la página.
                    </p>
                `;
            }
        }

        // Renderizar carrito
        function renderCart() {
            const container = document.getElementById('cart-items');
            
            if (cartData.items.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; padding: 48px 16px;">
                        Tu carrito está vacío.
                        <br><br>
                        <a href="../index.html" style="color: #6F7C12; font-weight: 600;">
                            ← Volver a la tienda
                        </a>
                    </p>
                `;
                updateSummary();
                return;
            }

            container.innerHTML = cartData.items.map(item => `
                <article class="cart-item" data-product-id="${item.id}">
                    <div class="item-image">
                        <img src="${item.image}" alt="${item.name}">
                    </div>
                    <div class="item-details">
                        <h3 class="item-name">${item.name}</h3>
                        <p class="item-description">${item.description || 'Producto de paracord'}</p>
                        <div class="item-price">${item.price.toFixed(2)} €</div>
                    </div>
                    <div class="item-quantity">
                        <button class="qty-btn" onclick="updateQuantity(${item.id}, 'decrease')" aria-label="Disminuir cantidad">-</button>
                        <input type="number" value="${item.quantity}" min="1" class="qty-input" readonly>
                        <button class="qty-btn" onclick="updateQuantity(${item.id}, 'increase')" aria-label="Aumentar cantidad">+</button>
                    </div>
                    <div class="item-total">${item.total.toFixed(2)} €</div>
                    <button class="item-remove" onclick="updateQuantity(${item.id}, 'decrease')" aria-label="Eliminar producto">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </article>
            `).join('');

            updateSummary();
        }

        // Actualizar resumen
        function updateSummary() {
            if (!cartData) return;

            document.getElementById('cart-count').textContent = cartData.summary.itemCount;
            document.getElementById('summary-subtotal').textContent = cartData.summary.subtotal.toFixed(2) + ' €';
            document.getElementById('summary-shipping').textContent = cartData.summary.shipping.toFixed(2) + ' €';
            document.getElementById('summary-total').textContent = cartData.summary.total.toFixed(2) + ' €';
        }

        // Actualizar cantidad
        async function updateQuantity(productId, action) {
            try {
                const response = await fetch('/student008/shop/endpoints/update_cart.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        action: action
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Recargar carrito completo
                    await loadCart();
                } else {
                    alert('Error al actualizar: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar el carrito');
            }
        }

        // Inicializar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadCart);
        } else {
            loadCart();
        }
    </script>
</body>
</html>